<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="revisit-after" content="30 days"><meta name="robots" content="index, follow"><meta name="viewport" content="initial-scale=1"><title>Speeding up Jekyll site | blog | configuration | css | Dmytro Kovalov</title><meta name="description" content="Google and other search engines consider page load speed when building their ratings. It means that improving load speed can boost your SEO rating too, not only your users happiness.
"><meta name="keywords" content="blog,configuration,css,github,jekyll,ruby"/><meta name="revised" content="Dmytro Kovalov,  2013/10/29"/><meta name="author" content="Dmytro Kovalov"/><link rel="icon" href="/images/favicon.ico"><link href='http://fonts.googleapis.com/css?family=Noto+Sans&subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'><link href='http://fonts.googleapis.com/css?family=Seymour+One&subset=latin,cyrillic' rel='stylesheet' type='text/css'><link href='http://fonts.googleapis.com/css?family=Comfortaa&subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'><link href='http://fonts.googleapis.com/css?family=Lobster&subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'><link href='http://fonts.googleapis.com/css?family=Inconsolata:700' rel='stylesheet' type='text/css'><link rel="stylesheet" href="/assets/app-3f5a79517a3bd0c6ca29fc1e64df7feb.css"> <script src="/assets/app-b80c4942bb62b4e63380a8693c39923c.js"></script><meta name="thefeedbackbutton" content="Github:ed4d541b3268b2dc5250684b57864d"> <script src="http://www.thefeedbackbutton.com/button.js"></script><script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-33505287-1"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><meta name="google-translate-customization" content="e5305daecdf84461-c504f9bf5024d6b1-gef663547868bd15e-10"></meta></head><body><div id="fb-root"></div> <script>!function(e,t,n){var c,o=e.getElementsByTagName(t)[0];e.getElementById(n)||(c=e.createElement(t),c.id=n,c.src="//connect.facebook.net/en_US/all.js#xfbml=1",o.parentNode.insertBefore(c,o))}(document,"script","facebook-jssdk")</script> <script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://apis.google.com/js/plusone.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div id="tiki-top"><table style="margin:0;padding:0" cellspacing="0" cellpadding="0" width="100%" columns="3"><tbody><tr style="padding:0;margin:0"><td style="width:120px;background-color:#D9A005;color:#8b0b04;font-wight:bold;text-align:right;padding:1em;padding-top:2em;border:0;border-right:10px solid #000"><p class="motto plus">Лупайте сю скалу...</p><p class='motto'>Іван Франко</p></td><td style="border:0"> <a href="http://yarylo.sytes.net/"><img align="right" border="0" src="/images/yarylo.png"></a> <br clear="all"><div id="top_bar_title"> <a href="http://yarylo.sytes.net/dmytro" style="color:#8B0B04">Уроки пані Маєш</a></div><div style="float:left"><div class="fb-like" data-send="false" data-layout="button_count" data-width="450" data-show-faces="true"></div><div align="right" class="g-plusone" data-size="medium"></div></div><div style="float:right;padding:5px"><div ><img height="14" width="14" src="/images/feed-icon-14x14.png"> <a href="rss.xml">RSS</a> | <a href="atom.xml">Atom</a></div></div></td><td style="border:0;border-left:10px solid #000;width:200px;background-color:#8B0B04"><p class="editdate" style="font-size:small;color:#D9A005;margin:5px;margin-top:100px;margin-right:80px"> 10 March 2015</p></td></tr></tbody></table></div><div id="tiki-mid"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td id="leftcolumn"><p id="preamble"><a class="top" href="/"><h1>TOP »</h1></a><p><a name="tags"></a><div id='tag_cloud'> <a href="/tags.html#mac" title="mac" rel="9">mac</a> <a href="/tags.html#history" title="history" rel="9">history</a> <a href="/tags.html#solaris" title="solaris" rel="1">solaris</a> <a href="/tags.html#email" title="email" rel="2">email</a> <a href="/tags.html#sendmail" title="sendmail" rel="1">sendmail</a> <a href="/tags.html#cli" title="cli" rel="7">cli</a> <a href="/tags.html#nfs" title="nfs" rel="1">nfs</a> <a href="/tags.html#configuration" title="configuration" rel="15">configuration</a> <a href="/tags.html#interesting" title="interesting" rel="2">interesting</a> <a href="/tags.html#linux" title="linux" rel="6">linux</a> <a href="/tags.html#debian" title="debian" rel="4">debian</a> <a href="/tags.html#xwindow" title="xwindow" rel="1">xwindow</a> <a href="/tags.html#css" title="css" rel="4">css</a> <a href="/tags.html#disk" title="disk" rel="1">disk</a> <a href="/tags.html#books" title="books" rel="1">books</a> <a href="/tags.html#fun" title="fun" rel="1">fun</a> <a href="/tags.html#cobbler" title="cobbler" rel="1">cobbler</a> <a href="/tags.html#installation" title="installation" rel="3">installation</a> <a href="/tags.html#troubleshooting" title="troubleshooting" rel="2">troubleshooting</a> <a href="/tags.html#ntp" title="ntp" rel="1">ntp</a> <a href="/tags.html#environment" title="environment" rel="3">environment</a> <a href="/tags.html#perl" title="perl" rel="1">perl</a> <a href="/tags.html#request tracker" title="request tracker" rel="2">request tracker</a> <a href="/tags.html#ruby" title="ruby" rel="12">ruby</a> <a href="/tags.html#development" title="development" rel="5">development</a> <a href="/tags.html#gem" title="gem" rel="1">gem</a> <a href="/tags.html#nagios" title="nagios" rel="4">nagios</a> <a href="/tags.html#monitoring" title="monitoring" rel="4">monitoring</a> <a href="/tags.html#nagira" title="nagira" rel="4">nagira</a> <a href="/tags.html#ssh" title="ssh" rel="1">ssh</a> <a href="/tags.html#tmux" title="tmux" rel="2">tmux</a> <a href="/tags.html#tips" title="tips" rel="8">tips</a> <a href="/tags.html#unix" title="unix" rel="3">unix</a> <a href="/tags.html#shell" title="shell" rel="3">shell</a> <a href="/tags.html#zsh" title="zsh" rel="1">zsh</a> <a href="/tags.html#prompt" title="prompt" rel="1">prompt</a> <a href="/tags.html#RESTful API" title="RESTful API" rel="3">RESTful API</a> <a href="/tags.html#blog" title="blog" rel="3">blog</a> <a href="/tags.html#github" title="github" rel="3">github</a> <a href="/tags.html#jekyll" title="jekyll" rel="3">jekyll</a> <a href="/tags.html#chef" title="chef" rel="3">chef</a> <a href="/tags.html#capistrano" title="capistrano" rel="3">capistrano</a> <a href="/tags.html#deployment" title="deployment" rel="3">deployment</a> <a href="/tags.html#Japan" title="Japan" rel="14">Japan</a> <a href="/tags.html#Ukrainian" title="Ukrainian" rel="14">Ukrainian</a> <a href="/tags.html#travel" title="travel" rel="13">travel</a> <a href="/tags.html#culture" title="culture" rel="4">culture</a> <a href="/tags.html#iphoto" title="iphoto" rel="1">iphoto</a></div></p><h1 class="even">Selected projects <a style="float:right" href="/github.html"><b>See all » </b></a></h1><a href="/banalize.html">Banalize: Bash static code analyzer</a><a href="/dbi-report-excel.html">DBIx::Report::Excel</a><a href="/dotfiles/index.html">Shell settings, AKA dotfiles</a><a href="/nagios_couchbase.html">Nagios Monitoring for Couchbase server</a><a href="/nagira/index.html">Nagira: RESTful API for Nagios</a><a href="/startpack.html">Startpack for Github pages development</a><a href="/Web-iPhoto/index.html">Web iPhoto</a><a name="blog"></a><h1>Blog <a style="float:right" href="/posts.html"><b>All posts » </b></a></h1> <a href="/series/Lito_na_pivnochi_YAponiyi.html"> Series: Літо на півночі Японії</a><a href="/2014/09/16/iphoto_and_files_permission..html">iPhoto and files permission </a><a href="/2014/01/31/vytoky_ukrayinskoyi_wikipediyi.html">Витоки української Вікіпедії </a><a href="/2013/12/20/is_macosx_10.9_macos_9.x..html">Is MacOSX 10.9 == MacOS 9.x? </a><a href="/2013/12/04/running_chef_roles_from_capistrano.html">Running Chef roles from Capistrano </a><a href="/2013/11/01/chef_and_capistrano_integration.html">und Capiche </a><a href="/2013/10/29/optimizing_jekyll.html">Github & Jekyll: Speeding up Jekyll site</a><a href="/2013/08/13/more_about_jekyll.html">Github & Jekyll: More experience with Jekyll and setup changes</a><a href="/2013/05/21/easy_spawn_new_hosts_with_capistrano.html">Build new hosts with Capistrano and Chef </a><a href="/2013/05/15/custom_css_for_rt4.html">Request Tracker: More about custom CSS for RT4</a><a href="/2013/03/18/ruby_2_test_drive.html">Ruby 2 test drive </a><a href="/2013/03/15/nagira_v0.2.5_release.html">Nagira v0.2.5 release </a><h1 class="even">Slides <a style="float:right" href="/presentations"><b>See all » </b></a></h1> <a href=/ presentations/ nagira_tlug. html>Nagira @TLUG, 2012</a><a href=/ presentations/ rspec_and_guard. html>Rspec and Guard</a><a name="about"></a><h1>About</h1><a href="http://uk.wikipedia.org/wiki/%D0%AF%D1%80%D0%B8%D0%BB%D0%BE">Ярило</a> <a href="https://en.wikipedia.org/wiki/Jarilo">Yarylo, Jarilo</a> <a href="http://github.com/dmytro">me @ github</a> <a href="http://search.cpan.org/~dmytro">me @ CPAN</a> <a href="http://tinyurl.com/7j89dhl"> Dmytro (CV)</a><p><p></td><td id="centercolumn"><div class="wikitext"><div class="titlebar"> Speeding up Jekyll site<div style="float:right;padding-right:10px" id="google_translate_element"></div><script>function googleTranslateElementInit(){new google.translate.TranslateElement({pageLanguage:"en",includedLanguages:"en,ja,uk",layout:google.translate.TranslateElement.InlineLayout.SIMPLE,multilanguagePage:!0,gaTrack:!0,gaId:"UA-33505287-1"},"google_translate_element")}</script><script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script></div><div id="related"> <script>function createTOC(a,t){var e=0,h=$("<ul id='bookmarksList'>");$("#content").children(a).each(function(){$(this).html("<a name='bookmark"+e+"'></a>"+$(this).html()),h.append($("<li class='"+this.nodeName+"'><a href='#bookmark"+e++ +"'>"+$(this).text()+"</a></li>"))}),$("#"+t).append(h)}$("document").ready(function(){createTOC("h1,h2,h3,h4,h5,h6","TOC   ")})</script><style>#TOC.bookmarkList li{list-style-type:none}li:first-child{text-indent:0}.H1,.H2,.H3,.H4,.H5,.H6{display:block}.H1{text-indent:0;font-size:100%}.H2{text-indent:2ex;font-size:90%}.H3{text-indent:4ex;font-size:80%}.H4{text-indent:6ex;font-size:70%}.H5{text-indent:8ex;font-size:60%}.H6{text-indent:10ex;font-size:50%}</style><strong id="toc_title">Table Of Contents</strong><div id="TOC"></div><h3>Related Posts</h3><ul class="posts"><li class="blog-toc-item"><a href="/2013/08/13/more_about_jekyll.html">More experience with Jekyll and setup changes</a></li><li class="blog-toc-item"><a href="/2012/12/22/jekyll-tags-pygmnents.html">New tricks and questions with Jekyll</a></li><li class="blog-toc-item"><a href="/2013/05/15/custom_css_for_rt4.html">More about custom CSS for RT4</a></li><li class="blog-toc-item"><a href="/2012/07/18/rt-custom-css.html">RT4 can be less ugly</a></li><li class="blog-toc-item"><a href="/2004/10/08/T09_42_28_09_00.html">Заголовок з відступом -- CSS</a></li></ul><p><h3>Tags</h3><span class="list_separatop">: </span><a href="/tags.html#blog">blog</a><span class="list_separatop"> : </span><a href="/tags.html#configuration">configuration</a><span class="list_separatop"> : </span><a href="/tags.html#css">css</a><span class="list_separatop"> : </span><a href="/tags.html#github">github</a><span class="list_separatop"> : </span><a href="/tags.html#jekyll">jekyll</a><span class="list_separatop"> : </span><a href="/tags.html#ruby">ruby</a><span class="list_separatop"> : </span></p><div id="series"><hr class="thin"><div class="seriesNote"><div class="italic"> This article is Part 3 in a 3-Part Series.</div> <a href="/series/Github_&_Jekyll.html"><h3>Github & Jekyll (See all »)</h3></a><div class="small" style="display:block">Part 1 - <a href="/2012/12/22/jekyll-tags-pygmnents.html">New tricks and questions with Jekyll</a></div><div class="small" style="display:block">Part 2 - <a href="/2013/08/13/more_about_jekyll.html">More experience with Jekyll and setup changes</a></div><div class="small" style="display:block">Part 3 - This article</div></div></div></div><div id="content"><p><em>Recently I've added some optimizations to my Jekyll setup for faster page loading. Google and other search engines consider page load speed when building their ratings. It means that improving load speed can boost your SEO rating too, not only your users happiness. </em></p><h1>Understanding the problem</h1><p>Most of the optimizations in my case was about shrinking CSS, Javascript and images, removing blank spaces from HTML and reducing number of HTTP request by joining assets into single asset file.</p><p>But before doing optimization it is better to understand where do you stand and what do you want to optimize.</p><p>Good page speed analyzer can be help with the task, I've found decent one at <a href="http://gtmetrix.com/">http://gtmetrix.com/</a>. There are others as well, for example <a href="https://www.site24x7.com/web-page-analyzer.html">https://www.site24x7.com/web-page-analyzer.html</a>, Google has some too.</p><p>GTMetrics analyzer is pretty good, it grades the page by relative standing of your page to average page stats on the net, and can grade importance of each metric and recommendations for speed improvements. is Whatever comes red on their report is probably worth your attention.</p><p>In my case the most critical things where decreasing number of HTTP request for CSS and Javascript files and reducing size of the hosted images.</p><hr/><h1>Assets pipeline</h1><h2>Javascript and CSS handling</h2><p>I was quite pleased to find for the assets handling <code>jekyll-assets</code> gem that works with Jekyll out of the box, and it handles assets very similar to the way Rails does it, so less learning for me. There are other solutions as well, obviously I haven't tested all of them, but among tested ones this one is on of the better ones.</p><p>Adding the gem to Jekyll setup is quite simple, just include lines into <code>Gemfile</code> and <code>_plugins/ext.rb</code> accordingly:</p><div class="highlight"><pre><code class="ruby"><span class="n">gem</span> <span class="s1">'jekyll-assets'</span>
    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="nb">require</span> <span class="s1">'jekyll-assets'</span>
</code></pre></div><p>Next step is a bit of reorganizing of how Javascript and CSS (or SASS) files are laid out in your working directory.</p><p>In my setup JS and SASS files are in <code>./js/</code> and <code>./sass/</code> directories. Sass saves generated CSS's in <code>./css</code>. For generating CSS files during local testing and when publishing I had sass command in my Rake task — in more details this was described in <a href="/2013/08/13/more_about_jekyll.html">previous post</a> — but with introducing assets pipeline this became redundant.</p><p>Examples of the new Rake tasks are given below.</p><h3>Refactoring assets</h3><p><code>Jekyll-assets</code> introduces new directory <code>_assets</code> with subdirectories <code>stylesheets</code> and <code>javascripts</code>. I've moved all my .js and .sass files to the new location and replaced all <code>style</code> and <code>script</code> references from the code with just 2 lines:</p><pre><code>{% javascript app %}
{% stylesheet app %}
</code></pre><p><code>Jekyll-assets</code> uses similar to Rails assets declaration, so to include all of my JS and CSS, what I had to do is to create two new files — one in each directory.</p><ul><li>File <code>_assets/stylesheets/app.css</code><pre><code>  #= require cssnormalize-min
  #= require dmytro
  #= require pygments
  #= require fancybox
</code></pre></li><li>File <code>_assets/javascripts/app.js</code><pre><code>  #= require jquery
  #= require jquery.tagcloud
  #= require fancybox
  #= require tag_cloud
</code></pre></li></ul><p>Resulting parsed JS and CSS tags look like:</p><div class="highlight"><pre><code class="html"><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/assets/app-e4c2b9c81e41368c0fcc779280bd5530.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/assets/app-b80c4942bb62b4e63380a8693c39923c.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div><h2>Optimizing images</h2><p>Another important aspect of optimization is reducing file size of the images. There are two parts in it: reducing geometry of the (mainly) photos, and second is adding some optimization to reduce file of the image. Both JPEG's and PNG's can be reduced quite significantly.</p><h3>Reduce geometry of JPEG files</h3><p>First of all, files exported from iPhoto or such, can end up in a lot of various sizes. Sometimes you just forget to select proper reduction and have image files of impractical for the web sizes. ImageMagick can handle this quite easy, only needed is to add simple Rake task for it.</p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="ruby"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</code></pre></div></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">resize</span> <span class="nb">name</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span>
        <span class="n">sh</span> <span class="sx">%{mogrify -resize </span><span class="si">#{</span><span class="no">MAX_GEOMETRY</span><span class="o">[</span><span class="ss">:w</span><span class="o">]</span><span class="si">}</span><span class="sx">x</span><span class="si">#{</span><span class="no">MAX_GEOMETRY</span><span class="o">[</span><span class="ss">:h</span><span class="o">]</span><span class="si">}</span><span class="sx"> '</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="sx">'}</span>
    <span class="k">end</span>

    <span class="no">MAX_GEOMETRY</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">w</span><span class="p">:</span> <span class="mi">1280</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="ss">h</span><span class="p">:</span> <span class="mi">960</span><span class="o">.</span><span class="mi">0</span> <span class="p">}</span>
    <span class="n">namespace</span> <span class="ss">:jpeg</span> <span class="k">do</span>

        <span class="n">task</span> <span class="ss">:list</span> <span class="k">do</span>
          <span class="vi">@jpgs</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"**/*.jpg"</span><span class="p">)</span> <span class="o">-</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"_site/**/*.jpg"</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">desc</span> <span class="s2">"Scale down images to max geometry allowed"</span>
        <span class="n">task</span> <span class="ss">:resize</span> <span class="o">=&gt;</span> <span class="ss">:list</span> <span class="k">do</span>
          <span class="n">files</span><span class="o">=</span> <span class="p">{</span> <span class="p">}</span>

          <span class="vi">@jpgs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">jpg</span><span class="o">|</span>
            <span class="no">IO</span><span class="o">.</span><span class="n">popen</span> <span class="s2">"identify '</span><span class="si">#{</span><span class="n">jpg</span><span class="si">}</span><span class="s2">'"</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
              <span class="n">f</span> <span class="o">=</span> <span class="nb">p</span><span class="o">.</span><span class="n">read</span>
              <span class="nb">name</span><span class="p">,</span><span class="n">bla</span><span class="p">,</span><span class="n">size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">)</span>
              <span class="nb">name</span><span class="o">.</span><span class="n">sub!</span><span class="p">(</span><span class="sr">/jpg\[\d+\]$/</span><span class="p">,</span> <span class="s1">'jpg'</span><span class="p">)</span>
              <span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_i</span><span class="p">)</span>
              <span class="k">next</span> <span class="k">unless</span> <span class="nb">name</span> <span class="o">&amp;&amp;</span> <span class="n">w</span> <span class="o">&amp;&amp;</span> <span class="n">h</span>
              <span class="n">resize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="no">MAX_GEOMETRY</span><span class="o">[</span><span class="ss">:w</span><span class="o">]</span> <span class="o">||</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="no">MAX_GEOMETRY</span><span class="o">[</span><span class="ss">:h</span><span class="o">]</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
</pre></div></td></tr></table><h3>Optimize JPEG's and PNG's</h3><p>Additionally to geometry reduction significant size reduction can be gained by optimizing imgages: removing unnecessary Exif tags and comments from JPEG's or applying various deflating algorithms. For PNG's optimizations are lossless, but for JPEG's you can select to reduce image quality or do lossless optimization.</p><p>Binaries for image optimizations are available for both MacOSX and Linux. On MacOSX <code>jpegoptim</code> is available as part of Homebrew and is installed simply by <code>brew install jpegoptim</code>. As for the PNG optimization <code>pngout</code> binary is downladable from <a href="http://www.jonof.id.au/kenutils">Ken Silverman's Utilities page</a>.</p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="ruby"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="n">desc</span> <span class="s2">"Compress JPEG images"</span>
    <span class="n">task</span> <span class="ss">:minimize</span> <span class="o">=&gt;</span> <span class="ss">:list</span> <span class="k">do</span>
      <span class="vi">@jpgs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
        <span class="n">sh</span> <span class="s2">"jpegoptim --strip-all --totals -o '</span><span class="si">#{</span><span class="n">f</span><span class="si">}</span><span class="s2">'"</span>
      <span class="k">end</span>
<span class="k">end</span>

<span class="n">namespace</span> <span class="ss">:png</span> <span class="k">do</span>
<span class="o">[.</span><span class="n">.</span><span class="o">.</span> <span class="n">taks</span> <span class="n">list</span> <span class="n">omitted</span> <span class="o">.</span><span class="n">.</span><span class="o">.]</span>

<span class="n">desc</span> <span class="s2">"Compress PNG images"</span>
<span class="n">task</span> <span class="ss">:minimize</span> <span class="o">=&gt;</span> <span class="ss">:list</span> <span class="k">do</span>
  <span class="vi">@pngs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">png</span><span class="o">|</span>
    <span class="n">before</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">size</span> <span class="n">png</span>
    <span class="n">sh</span> <span class="s2">"./bin/pngout </span><span class="si">#{</span><span class="n">png</span><span class="si">}</span><span class="s2"> -q | true"</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">png</span><span class="si">}</span><span class="s2"> : </span><span class="si">#{</span><span class="n">before</span> <span class="o">-</span> <span class="no">File</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">png</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes smaller "</span>
  <span class="k">end</span></pre></div></td></tr></table><hr/><h1>HTML compression</h1><p>For further reduction of the web page(s) size stripping all excessive white spaces and html comments can help too. There's a Jekyll plug-in (more than one) for that too. I've tried couple of them and stopped on <code>jekyll-minify-html</code>.</p><p>It is also installable as gem. To start using in, just add <code>require 'jekyll-minify-html'</code> statement in <code>_plugins/ext.rb</code> and <code>env: production</code> in <code>_config.yml</code>. That's it.</p><p>However I find it quite heave and usually comment out when previewing page locally. That's brings another topic of Jekyll slowness, see below.</p><hr/><h1>Rake tasks</h1><p>Finally, these are new Rake tasks for publishing site to Github and for building it locally for preview.</p><h3>Rake run</h3><p>This task starts locally Jekyll for previewing site on the local machine.</p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="ruby"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="n">desc</span> <span class="s2">"compile and run the site locally"</span>
<span class="n">task</span> <span class="ss">:run</span> <span class="k">do</span>
  <span class="n">pids</span> <span class="o">=</span> <span class="o">[</span> <span class="n">spawn</span><span class="p">(</span><span class="s2">"jekyll serve --watch --drafts"</span><span class="p">)</span> <span class="o">]</span>

  <span class="nb">trap</span> <span class="s2">"INT"</span> <span class="k">do</span>
    <span class="no">Process</span><span class="o">.</span><span class="n">kill</span> <span class="s2">"INT"</span><span class="p">,</span> <span class="o">*</span><span class="n">pids</span>
    <span class="nb">exit</span> <span class="mi">1</span>
  <span class="k">end</span>

  <span class="kp">loop</span> <span class="p">{</span> <span class="nb">sleep</span> <span class="mi">1</span> <span class="p">}</span>
<span class="k">end</span></pre></div></td></tr></table><h3>Rake publish</h3><p>Build site and publish it to Github. In this task I also use <code>jpegoptim</code> to optimize all thumb-nails from <a href="https://github.com/redwallhp/JekyllGalleryTag">Jekyll GalleryTag plugin</a> which are generated automatically on page build (on line 6).</p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="ruby">1
2
3
4
5
6
7
8</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="n">desc</span> <span class="s2">"compile and publish the site to Github"</span>
<span class="n">task</span> <span class="ss">:publish</span> <span class="k">do</span>
  <span class="n">sh</span> <span class="s2">"git checkout source"</span>
  <span class="n">comment</span> <span class="o">=</span> <span class="sx">%x{ git log -n 1 --no-merges --format=%s%b }</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">strip</span>
  <span class="n">sh</span> <span class="s2">"jekyll build"</span>
  <span class="n">sh</span> <span class="s2">"jpegoptim --strip-all --totals -o _site/images/galleries/*-thumb*"</span>
  <span class="n">sh</span> <span class="s2">"cd _site &amp;&amp; git add -A &amp;&amp; git commit -m </span><span class="se">\"</span><span class="s2">Publishing at $(date): </span><span class="si">#{</span><span class="n">comment</span><span class="si">}</span><span class="se">\"</span><span class="s2"> &amp;&amp; git push origin master"</span>
<span class="k">end</span></pre></div></td></tr></table><hr/><h1>Some stats ...</h1><p>Just some stats about size reduction as result of these experiments. There numbers are far from being precise. During all these changes I kept adding posts and images to the site, so it's hard to tell exactly how much space each one have saved. I only can roll back my git repo and see how size changed between commits.</p><table><tr><th> <th>Before<th> After<tr><td><em>Full page generated size (kB's)</em><td> 483,524<td> 478,324<tr><td><em>Number of image files</em><td> 375<td> 878<tr><td><em>Assets size (kB's)</em><td> 88(css) + 184(js)<td> 188 <em class='smaller'>(JS+CSS together, including GZ'ipped copies)</em><tr><td><em>GTmetrix Y Slow grade</em><td> C<td> B</table><p>Even with number of photos (main size factor on this site) increase about twice overall size went a bit down, and as for JS and CSS total size reduced by about 40%, not mentioning that instead of about dozen HTTP requests there are only 2 now.</p><h1>... and problems</h1><h2>Jekyll is slow</h2><p>After I started playing with multiple Jekyll plugins, I've started noticing significant slowing of the page generation. Even for small page changes it takes multiple tens of seconds to recreate file and page reload often show missing file or not regenerated CSS's.</p><p>Full page build with CSS/JSS/HTML compression tames more than 2 minutes, and this is only for 48 blog posts (this one is 49's).</p><h2>Liquid is quite limiting</h2><p>Another problem is that Liquid templating used by Jekyll is, while easy to learn one, is quite limited and a bit hard to extend.</p><p>I am finding that doing even simple (not-supported) things in Liquid is virtually impossible without writing custom plugin. Things, that in ERB would be done with 2-3 ruby commands, requires a lot of jumping through the loops.</p><h3>Middleman?</h3><p>Time to look for something new?</p><p>Recently I've read some intros to <a href="http://middlemanapp.com/">Middleman</a>.</p><p>So far my impressions are:</p><ul><li>ERB vs Liquid is <em>GOOD THING</em>. <em>I can compare this relationship to that one of Puppet vs Chef, i.e. custom configuration language plus some added on top of it Ruby DSL vs clean from the start DSL</em>;</li><li>things, that require a lot of plumbing in Jekyll are by default in Middleman (one example, being <a href="http://middlemanapp.com/asset-pipeline/">Asset Pipeline</a>).</li></ul><p>Oh well...</p></div><hr><div id="blog-toc"><div class="toc-title">More Posts</div> <span class="blog-toc-item"><a href="/2014/09/16/iphoto_and_files_permission..html">iPhoto and files permission</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2014/01/31/vytoky_ukrayinskoyi_wikipediyi.html">Витоки української Вікіпедії</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/12/20/is_macosx_10.9_macos_9.x..html">Is MacOSX 10.9 == MacOS 9.x?</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/12/04/running_chef_roles_from_capistrano.html">Running Chef roles from Capistrano</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/11/01/chef_and_capistrano_integration.html">und Capiche</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/10/29/optimizing_jekyll.html">Speeding up Jekyll site</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/08/13/more_about_jekyll.html">More experience with Jekyll and setup changes</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/08/01/back_home.html">День останній: два роки після цунамі</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/31/ryusendo.html">Джерело Дракона, Рюсендо</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/31/hachimantai.html">День десятий: вулкани і болота Хачімантаю</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/30/tsuruno_onsen.html">Екстремальна екзотика в Цуруно онсен</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/29/day_8_tazawako.html">День восьмий: Найглибше озеро Японії</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/29/day_4_chusonji.html">День четвертий: багато буддистських святинь</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/25/day_5to7_tokoton_yama_IV.html">Токотон-яма (IV). Пекло.</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/25/day_5to7_tokoton_yama_III.html">Токотон-яма (III). Каньйон з гейзерами.</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/25/day_5to7_tokoton_yama_II.html">Автокемпінг Токотон-яма (II)</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/25/day_5to7_tokoton_yama_I.html">Три дні в Токотон-яма (I). Сукава онсен.</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/24/day_three_yamadera.html">День третій: Окама і Ямадера</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/23/druhyi_den.html">Другий день</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/22/pershyi_den.html">День перший: Фукушіма, рухаємося на північ.</a></span><span class="list_separatop">|</span></div></table><div id="tiki-bot"><table style="border-:0;border-top:10px solid #000;margin:0;padding:0" cellspacing="0" cellpadding="0" width="100%" columns="2"><tbody><tr style="padding:0;margin:0"><td style="width:80%;background-color:#052D6C;color:#8b0b04;font-style:italic;font-wight:bold;text-align:right;border:0"> <br clear="all"><br clear="all"><br clear="all"><br clear="all"></td><td style="border:0;border-left:10px solid #000;width:120px;padding:5px"> <a class="address" href="mailto:dmytro.kovalov@gmail.com">дмитро ковальов</a></br> <a class="address" href="https://dmytro.github.com/">dmytro @ github </a><br> <a class="address" href="http://dmytro.sytes.net">dmytro.sytes.net</a><br></td></tr></tbody></table></div> <script>$("#content table tr:even").attr("class","even")</script></body></html>