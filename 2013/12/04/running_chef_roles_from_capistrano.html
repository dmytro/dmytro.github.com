<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="revisit-after" content="30 days"><meta name="robots" content="index, follow"><meta name="viewport" content="initial-scale=1"><title>Running Chef roles from Cap... | capistrano | chef | deployment | Dmytro Kovalov</title><meta name="description" content="Databags are generated on Capistrano side and then used by Chef for server and components configuration.
"><meta name="keywords" content="capistrano,chef,deployment,ruby,configuration,development"/><meta name="revised" content="Dmytro Kovalov,  2013/12/04"/><meta name="author" content="Dmytro Kovalov"/><link rel="icon" href="/images/favicon.ico"><link href='http://fonts.googleapis.com/css?family=Noto+Sans&subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'><link href='http://fonts.googleapis.com/css?family=Seymour+One&subset=latin,cyrillic' rel='stylesheet' type='text/css'><link href='http://fonts.googleapis.com/css?family=Comfortaa&subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'><link href='http://fonts.googleapis.com/css?family=Lobster&subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'><link href='http://fonts.googleapis.com/css?family=Inconsolata:700' rel='stylesheet' type='text/css'><link rel="stylesheet" href="/assets/app-3f5a79517a3bd0c6ca29fc1e64df7feb.css"> <script src="/assets/app-b80c4942bb62b4e63380a8693c39923c.js"></script><meta name="thefeedbackbutton" content="Github:ed4d541b3268b2dc5250684b57864d"> <script src="http://www.thefeedbackbutton.com/button.js"></script><script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-33505287-1"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><meta name="google-translate-customization" content="e5305daecdf84461-c504f9bf5024d6b1-gef663547868bd15e-10"></meta></head><body><div id="fb-root"></div> <script>!function(e,t,n){var c,o=e.getElementsByTagName(t)[0];e.getElementById(n)||(c=e.createElement(t),c.id=n,c.src="//connect.facebook.net/en_US/all.js#xfbml=1",o.parentNode.insertBefore(c,o))}(document,"script","facebook-jssdk")</script> <script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://apis.google.com/js/plusone.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><a href="https://github.com/dmytro/und_capiche"> <img id="ribbon" src="http://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"/></a><div id="tiki-top"><table style="margin:0;padding:0" cellspacing="0" cellpadding="0" width="100%" columns="3"><tbody><tr style="padding:0;margin:0"><td style="width:120px;background-color:#D9A005;color:#8b0b04;font-wight:bold;text-align:right;padding:1em;padding-top:2em;border:0;border-right:10px solid #000"><p class="motto plus">Лупайте сю скалу...</p><p class='motto'>Іван Франко</p></td><td style="border:0"> <a href="http://yarylo.sytes.net/"><img align="right" border="0" src="/images/yarylo.png"></a> <br clear="all"><div id="top_bar_title"> <a href="http://yarylo.sytes.net/dmytro" style="color:#8B0B04">Уроки пані Маєш</a></div><div style="float:left"><div class="fb-like" data-send="false" data-layout="button_count" data-width="450" data-show-faces="true"></div><div align="right" class="g-plusone" data-size="medium"></div></div><div style="float:right;padding:5px"><div ><img height="14" width="14" src="/images/feed-icon-14x14.png"> <a href="rss.xml">RSS</a> | <a href="atom.xml">Atom</a></div></div></td><td style="border:0;border-left:10px solid #000;width:200px;background-color:#8B0B04"><p class="editdate" style="font-size:small;color:#D9A005;margin:5px;margin-top:100px;margin-right:80px"> 16 September 2014</p></td></tr></tbody></table></div><div id="tiki-mid"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td id="leftcolumn"><p id="preamble"><a class="top" href="/"><h1>TOP »</h1></a><p><a name="tags"></a><div id='tag_cloud'> <a href="/tags.html#mac" title="mac" rel="9">mac</a> <a href="/tags.html#history" title="history" rel="9">history</a> <a href="/tags.html#solaris" title="solaris" rel="1">solaris</a> <a href="/tags.html#email" title="email" rel="2">email</a> <a href="/tags.html#sendmail" title="sendmail" rel="1">sendmail</a> <a href="/tags.html#cli" title="cli" rel="7">cli</a> <a href="/tags.html#nfs" title="nfs" rel="1">nfs</a> <a href="/tags.html#configuration" title="configuration" rel="15">configuration</a> <a href="/tags.html#interesting" title="interesting" rel="2">interesting</a> <a href="/tags.html#linux" title="linux" rel="6">linux</a> <a href="/tags.html#debian" title="debian" rel="4">debian</a> <a href="/tags.html#xwindow" title="xwindow" rel="1">xwindow</a> <a href="/tags.html#css" title="css" rel="4">css</a> <a href="/tags.html#disk" title="disk" rel="1">disk</a> <a href="/tags.html#books" title="books" rel="1">books</a> <a href="/tags.html#fun" title="fun" rel="1">fun</a> <a href="/tags.html#cobbler" title="cobbler" rel="1">cobbler</a> <a href="/tags.html#installation" title="installation" rel="3">installation</a> <a href="/tags.html#troubleshooting" title="troubleshooting" rel="2">troubleshooting</a> <a href="/tags.html#ntp" title="ntp" rel="1">ntp</a> <a href="/tags.html#environment" title="environment" rel="3">environment</a> <a href="/tags.html#perl" title="perl" rel="1">perl</a> <a href="/tags.html#request tracker" title="request tracker" rel="2">request tracker</a> <a href="/tags.html#ruby" title="ruby" rel="12">ruby</a> <a href="/tags.html#development" title="development" rel="5">development</a> <a href="/tags.html#gem" title="gem" rel="1">gem</a> <a href="/tags.html#nagios" title="nagios" rel="4">nagios</a> <a href="/tags.html#monitoring" title="monitoring" rel="4">monitoring</a> <a href="/tags.html#nagira" title="nagira" rel="4">nagira</a> <a href="/tags.html#ssh" title="ssh" rel="1">ssh</a> <a href="/tags.html#tmux" title="tmux" rel="2">tmux</a> <a href="/tags.html#tips" title="tips" rel="8">tips</a> <a href="/tags.html#unix" title="unix" rel="3">unix</a> <a href="/tags.html#shell" title="shell" rel="3">shell</a> <a href="/tags.html#zsh" title="zsh" rel="1">zsh</a> <a href="/tags.html#prompt" title="prompt" rel="1">prompt</a> <a href="/tags.html#RESTful API" title="RESTful API" rel="3">RESTful API</a> <a href="/tags.html#blog" title="blog" rel="3">blog</a> <a href="/tags.html#github" title="github" rel="3">github</a> <a href="/tags.html#jekyll" title="jekyll" rel="3">jekyll</a> <a href="/tags.html#chef" title="chef" rel="3">chef</a> <a href="/tags.html#capistrano" title="capistrano" rel="3">capistrano</a> <a href="/tags.html#deployment" title="deployment" rel="3">deployment</a> <a href="/tags.html#Japan" title="Japan" rel="14">Japan</a> <a href="/tags.html#Ukrainian" title="Ukrainian" rel="14">Ukrainian</a> <a href="/tags.html#travel" title="travel" rel="13">travel</a> <a href="/tags.html#culture" title="culture" rel="4">culture</a> <a href="/tags.html#iphoto" title="iphoto" rel="1">iphoto</a></div></p><h1 class="even">Selected projects <a style="float:right" href="/github.html"><b>See all » </b></a></h1><a href="/aws-deploy.html">AWS Deploy</a><a href="/banalize.html">Banalize: Bash static code analyzer</a><a href="/dbi-report-excel.html">DBIx::Report::Excel</a><a href="/dotfiles/index.html">Shell settings, AKA dotfiles</a><a href="/github_keys/index.html">Github keys</a><a href="/nagios_couchbase.html">Nagios Monitoring for Couchbase server</a><a href="/nagira/index.html">Nagira: RESTful API for Nagios</a><a href="/rfb.html">Ready For Business Automation system</a><a href="/rspec_normalized_hash/index.html">RSpec tests for Normalized Hash</a><a href="/Web-iPhoto/index.html">Web iPhoto</a><a name="blog"></a><h1>Blog <a style="float:right" href="/posts.html"><b>All posts » </b></a></h1> <a href="/series/Lito_na_pivnochi_YAponiyi.html"> Series: Літо на півночі Японії</a><a href="/2014/09/16/iphoto_and_files_permission..html">iPhoto and files permission </a><a href="/2014/01/31/vytoky_ukrayinskoyi_wikipediyi.html">Витоки української Вікіпедії </a><a href="/2013/12/20/is_macosx_10.9_macos_9.x..html">Is MacOSX 10.9 == MacOS 9.x? </a><a href="/2013/12/04/running_chef_roles_from_capistrano.html">Running Chef roles from Capistrano </a><a href="/2013/11/01/chef_and_capistrano_integration.html">und Capiche </a><a href="/2013/10/29/optimizing_jekyll.html">Github & Jekyll: Speeding up Jekyll site</a><a href="/2013/08/13/more_about_jekyll.html">Github & Jekyll: More experience with Jekyll and setup changes</a><a href="/2013/05/21/easy_spawn_new_hosts_with_capistrano.html">Build new hosts with Capistrano and Chef </a><a href="/2013/05/15/custom_css_for_rt4.html">Request Tracker: More about custom CSS for RT4</a><a href="/2013/03/18/ruby_2_test_drive.html">Ruby 2 test drive </a><a href="/2013/03/15/nagira_v0.2.5_release.html">Nagira v0.2.5 release </a><h1 class="even">Slides <a style="float:right" href="/presentations"><b>See all » </b></a></h1> <a href=/ presentations/ nagira_tlug. html>Nagira @TLUG, 2012</a><a href=/ presentations/ rspec_and_guard. html>Rspec and Guard</a><a name="about"></a><h1>About</h1><a href="http://uk.wikipedia.org/wiki/%D0%AF%D1%80%D0%B8%D0%BB%D0%BE">Ярило</a> <a href="https://en.wikipedia.org/wiki/Jarilo">Yarylo, Jarilo</a> <a href="http://github.com/dmytro">me @ github</a> <a href="http://search.cpan.org/~dmytro">me @ CPAN</a> <a href="http://tinyurl.com/7j89dhl"> Dmytro (CV)</a><p><p></td><td id="centercolumn"><div class="wikitext"><div class="titlebar"> Running Chef roles from Capistrano<div style="float:right;padding-right:10px" id="google_translate_element"></div><script>function googleTranslateElementInit(){new google.translate.TranslateElement({pageLanguage:"en",includedLanguages:"en,ja,uk",layout:google.translate.TranslateElement.InlineLayout.SIMPLE,multilanguagePage:!0,gaTrack:!0,gaId:"UA-33505287-1"},"google_translate_element")}</script><script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script></div><div id="related"> <script>function createTOC(a,t){var e=0,h=$("<ul id='bookmarksList'>");$("#content").children(a).each(function(){$(this).html("<a name='bookmark"+e+"'></a>"+$(this).html()),h.append($("<li class='"+this.nodeName+"'><a href='#bookmark"+e++ +"'>"+$(this).text()+"</a></li>"))}),$("#"+t).append(h)}$("document").ready(function(){createTOC("h1,h2,h3,h4,h5,h6","TOC   ")})</script><style>#TOC.bookmarkList li{list-style-type:none}li:first-child{text-indent:0}.H1,.H2,.H3,.H4,.H5,.H6{display:block}.H1{text-indent:0;font-size:100%}.H2{text-indent:2ex;font-size:90%}.H3{text-indent:4ex;font-size:80%}.H4{text-indent:6ex;font-size:70%}.H5{text-indent:8ex;font-size:60%}.H6{text-indent:10ex;font-size:50%}</style><strong id="toc_title">Table Of Contents</strong><div id="TOC"></div><h3>Related Posts</h3><ul class="posts"><li class="blog-toc-item"><a href="/2013/11/01/chef_and_capistrano_integration.html">und Capiche</a></li><li class="blog-toc-item"><a href="/2013/05/21/easy_spawn_new_hosts_with_capistrano.html">Build new hosts with Capistrano and Chef</a></li><li class="blog-toc-item"><a href="/2013/01/08/memorizable_password_generation.html">Memorizable password generation</a></li><li class="blog-toc-item"><a href="/2012/09/09/my-first-gem.html">My first gem and first Rubygems impressions</a></li><li class="blog-toc-item"><a href="/2013/10/29/optimizing_jekyll.html">Speeding up Jekyll site</a></li></ul><p><h3>Tags</h3><span class="list_separatop">: </span><a href="/tags.html#capistrano">capistrano</a><span class="list_separatop"> : </span><a href="/tags.html#chef">chef</a><span class="list_separatop"> : </span><a href="/tags.html#deployment">deployment</a><span class="list_separatop"> : </span><a href="/tags.html#ruby">ruby</a><span class="list_separatop"> : </span><a href="/tags.html#configuration">configuration</a><span class="list_separatop"> : </span><a href="/tags.html#development">development</a><span class="list_separatop"> : </span></p></div><div id="content"><p><em>Chef databags are used to pass information between sessions of Capistrano and Chef. Databags are generated on Capistrano side and then used by Chef for server and components configuration. </em></p><p>In my new project <a href="/2013/11/01/chef_and_capistrano_integration.html"><em>und Capiche</em></a> I use tandem of Capistrano (or <em>cap</em>) and Chef-solo (<em>chef</em>) to deploy stacks of applications. Stacks are collections of server configuration, software packages required to run application, software configuration, and application code itself.</p><h1>Capistrano + Chef</h1><p>Here's a brief flow of typical deployment process in this schema:</p><ul><li>locally capistrano creates configuration to be used in Chef;</li><li><em>cap</em> copies Chef-solo and configuration to all remote hosts;</li><li><em>cap</em> starts chef-solo on remote hosts;</li><li>after <em>chef</em> finished, <em>cap</em> starts standard application deployment.</li></ul><h2>Databag messenger</h2><p>There are significant differences in how <em>cap</em> and <em>chef</em> executed. First and main difference is that they are invoked on different servers. <em>Cap</em> starts deployment from local server, but <em>chef</em> processes (possibly many of them) run on remote servers in parallel.</p><p>There are no standard ways (like calling method and passing arguments) for information exchange between <em>cap</em> and <em>chef</em>. I use <em>chef databags</em> as information medium between <em>cap</em> and <em>chef</em>.</p><p>Capistrano needs an ability to generate databags from its own configuration in the format that <em>chef</em> cookbooks understand; also capistrano should be able to read and search <em>chef</em> databags.</p><h3>Hosts (AKA nodes) databag</h3><p>First and very important task, is to be able to pass server configuration -- including roles -- from local Capistrano process to the remote nodes, where <em>chef</em> can use it. Example below shows how this could be implemented.</p><p>Suppose you have hosts configuration like the following:</p><div class="highlight"><pre><code class="ruby"><span class="n">server</span> <span class="s1">'10.0.1.10'</span><span class="p">,</span>  <span class="ss">:app</span><span class="p">,</span> <span class="ss">:web</span><span class="p">,</span> <span class="ss">:db</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">hostname</span><span class="p">:</span> <span class="s2">"mysql01"</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
<span class="n">server</span> <span class="s1">'10.0.1.11'</span><span class="p">,</span>  <span class="ss">:app</span><span class="p">,</span> <span class="ss">:web</span><span class="p">,</span>              <span class="ss">hostname</span><span class="p">:</span> <span class="s2">"web01"</span>
<span class="n">server</span> <span class="s1">'10.0.1.12'</span><span class="p">,</span>  <span class="ss">:app</span><span class="p">,</span> <span class="ss">:web</span><span class="p">,</span>              <span class="ss">hostname</span><span class="p">:</span> <span class="s2">"web02"</span>
<span class="n">server</span> <span class="s1">'10.0.1.13'</span><span class="p">,</span> <span class="ss">:logger</span><span class="p">,</span> <span class="ss">:dns</span><span class="p">,</span> <span class="ss">:security</span><span class="p">,</span> <span class="ss">:monitoring</span><span class="p">,</span> <span class="n">no_release</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">hostname</span><span class="p">:</span> <span class="s2">"master"</span>
</code></pre></div><p>From this configuration Capistrano recipe creates databag called <code>:node</code> with one item for each capistrano host. Example of a recipe:</p><div class="highlight"><pre><code class="ruby"><span class="n">task</span> <span class="ss">:roles</span> <span class="k">do</span>
    <span class="n">find_servers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
        <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">server</span><span class="si">}</span><span class="s2">.json"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
            <span class="n">f</span><span class="o">.</span><span class="n">print</span><span class="p">({</span>
                <span class="nb">id</span><span class="p">:</span>        <span class="n">server</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\./</span><span class="p">,</span><span class="s1">'_'</span><span class="p">),</span>
                <span class="ss">role</span><span class="p">:</span>      <span class="n">role_names_for_host</span><span class="p">(</span><span class="n">server</span><span class="p">),</span>
                <span class="ss">fqdn</span><span class="p">:</span>      <span class="n">server</span><span class="o">.</span><span class="n">options</span><span class="o">[</span><span class="ss">:hostname</span><span class="o">]</span> <span class="o">||</span> <span class="n">server</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                <span class="ss">ipaddress</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                <span class="ss">options</span><span class="p">:</span>   <span class="n">server</span><span class="o">.</span><span class="n">options</span>
            <span class="p">}</span><span class="o">.</span><span class="n">to_json</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><p>Generated databag for one of the host looks like:</p><div class="highlight"><pre><code class="javascript"><span class="p">{</span>
    <span class="s2">"id"</span>        <span class="o">:</span> <span class="s2">"10_0_1_11"</span><span class="p">,</span>
    <span class="s2">"role"</span>      <span class="o">:</span> <span class="p">[</span><span class="s2">"logger"</span><span class="p">,</span> <span class="s2">"dns"</span><span class="p">,</span> <span class="s2">"security"</span><span class="p">,</span> <span class="s2">"monitoring"</span><span class="p">],</span>
    <span class="s2">"fqdn"</span>      <span class="o">:</span> <span class="s2">"10.0.1.11"</span><span class="p">,</span>
    <span class="s2">"ipdaress"</span>   <span class="o">:</span> <span class="s2">"10.0.1.11"</span><span class="p">,</span>
     <span class="s2">"options"</span> <span class="o">:</span> <span class="p">{</span>
         <span class="s2">"no_release"</span>    <span class="o">:</span> <span class="s2">"true"</span><span class="p">,</span>
         <span class="s2">"hostname"</span>      <span class="o">:</span> <span class="s2">"master"</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>This databag can be used directly with <em>chef</em> recipes, using <code>data_bag_item</code> or <code>search</code> methods as for example:</p><div class="highlight"><pre><code class="ruby"><span class="n">servers</span>    <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s1">'*'</span><span class="p">)</span>
<span class="n">monitoring</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s2">"roles:*monitoring*"</span><span class="p">)</span>
</code></pre></div><blockquote><p><strong>Note</strong>: There is one trick though. Recipe needs to be written in such a way as to support search in <em>Chef-solo</em>.</p><p>By default <em>Chef-solo</em> is only able to use data bags for <code>data_bag</code> and <code>data_bag_item</code> operations; to use search with solo you need to use extension <a href="TODO">chef-solo-search</a>.</p><p><strong>Note 2</strong>: In some cases this is not enough, however: if cookbook designed in such a way that search is explicitly prohibited in solo mode, some changes to the cookbook are necessary. Below is an example of the modifications I had to do for <em>Munin</em> cookbook to make it work with both <em>Chef-solo</em> and search.</p></blockquote><div class="highlight"><pre><code class="ruby"><span class="c1"># Original cookbook recipe</span>
<span class="k">if</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:solo</span><span class="o">]</span>
   <span class="n">sysadmins</span> <span class="o">=</span> <span class="n">data_bag</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span> <span class="p">}</span>

<span class="c1"># Change to</span>
<span class="n">cant_search</span> <span class="o">=</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:solo</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="o">.</span><span class="n">recipes</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="sr">/chef-solo-search/</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
<span class="k">if</span> <span class="n">cant_search</span>
   <span class="n">sysadmins</span> <span class="o">=</span> <span class="n">data_bag</span><span class="p">(</span><span class="s1">'users'</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div><h2>Applying Chef roles</h2><p>There are two sides to actual executing a Chef cookbook via capistrano: <em>cap</em> side and <em>chef</em>. On every server we need to execute command that applies configuration specific to that server. We could do this sequentially, by using <code>:hosts</code> option to <code>run</code> method, but this will be really slow.</p><p>Instead of this, I am using a bit of Capistrano magic and small Ruby script on remote server(s) side.</p><h3>Capistrano task</h3><p>Following task starts parallel run of remote script <code>run_roles.rb</code> on all servers with option that contains server name from <em>cap</em> configuration. This <code>$CAPISTRANO:HOST$</code> variable is special Capistrano magic, it is internally converted by Capistrano to <code>server.host</code> (Note: It is <em>not</em> shell variable, it is set by Capistrano <em>before</em> shell runs).</p><div class="highlight"><pre><code class="ruby"><span class="n">task</span> <span class="ss">:roles</span> <span class="k">do</span>
    <span class="n">run</span> <span class="sx">%Q{ </span><span class="si">#{</span><span class="n">try_sudo</span><span class="si">}</span><span class="sx"> </span><span class="si">#{</span><span class="n">chef_solo_remote</span><span class="si">}</span><span class="sx">/run_roles.rb  $CAPISTRANO:HOST$ }</span>
<span class="k">end</span>
</code></pre></div><p>On remote (i.e. <em>chef</em> side) there's a small script, that takes <code>server.host</code> as an argument and applies roles from <code>node</code> databag.</p><p>What happens here is the following:</p><ul><li>script reads databag with current server configuration;</li><li>it reads all roles files (<code>role.json</code>) that are listed in the databag;</li><li>combines them into single <code>run_list</code>; and</li><li>runs <em>chef-solo</em> using combined run list.</li></ul><div class="highlight"><pre><code class="ruby"><span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:solo</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
<span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:data_bag_path</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/data_bags"</span>
<span class="n">current_host</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\./</span><span class="p">,</span><span class="s1">'_'</span><span class="p">)</span>

<span class="nb">exit</span> <span class="k">unless</span> <span class="n">current_host</span>

<span class="n">roles</span> <span class="o">=</span>  <span class="ss">Chef</span><span class="p">:</span><span class="ss">:DataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="n">current_host</span><span class="p">)</span><span class="o">[</span><span class="s2">"role"</span><span class="o">]</span>

<span class="n">run_lists</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">roles</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="s2">"</span><span class="si">#{</span> <span class="n">current_path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">.json"</span><span class="p">}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">role</span><span class="o">|</span>
  <span class="n">run_lists</span> <span class="o">+=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span> <span class="n">role</span><span class="p">)</span><span class="o">[</span><span class="s2">"run_list"</span><span class="o">]</span>
<span class="k">end</span>

<span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">current_host</span><span class="si">}</span><span class="s2">.json"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="n">f</span><span class="o">.</span><span class="n">print</span><span class="p">({</span> <span class="n">run_list</span><span class="p">:</span> <span class="n">run_lists</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">uniq</span> <span class="p">}</span><span class="o">.</span><span class="n">to_json</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">cmd</span> <span class="o">=</span> <span class="s2">"cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; chef-solo --config solo.rb --json-attributes </span><span class="si">#{</span><span class="n">current_host</span><span class="si">}</span><span class="s2">.json"</span>
<span class="k">begin</span>
  <span class="no">PTY</span><span class="o">.</span><span class="n">spawn</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stout</span><span class="p">,</span> <span class="n">pid</span><span class="o">|</span>
    <span class="k">begin</span>
      <span class="n">stdin</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="nb">print</span> <span class="n">line</span> <span class="p">}</span>
    <span class="k">rescue</span> <span class="ss">Errno</span><span class="p">:</span><span class="ss">:EIO</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">rescue</span> <span class="ss">PTY</span><span class="p">:</span><span class="ss">:ChildExited</span>
  <span class="nb">puts</span> <span class="s2">"The child process exited!"</span>
<span class="k">end</span>
</code></pre></div><h1>Next steps</h1><p>To be able to deploy full stacks of applications additionally to basic hosts information Capistrano needs to share all its configuration with Chef. In next installments I will describe how this can be achieved.</p><h2> Author</h2><p> Dmytro Kovalov (<a href="mailto:dmytro.kovalov@gmail.com">dmytro.kovalov@gmail.com</a>)</p><div class="download"><h2>Source code</h2><div class="download links"> <a href="https://github.com/dmytro/und_capiche/zipball/master"><img border="0" src="https://github.com/images/modules/download/zip.png"></a><a href="https://github.com/dmytro/und_capiche/tarball/master"><img border="0" src="https://github.com/images/modules/download/tar.png"></a></div><ul><li>Download und_capiche in either zip or tar formats ⇒<li>Clone und_capiche with <a href="http://git-scm.com">git</a> <pre> $ git clone git://github.com/dmytro/und_capiche</pre><li>or go to <a href="http://github.com/dmytro/und_capiche">und_capiche's Github repository »</a></ul></div></div><hr><div id="blog-toc"><div class="toc-title">More Posts</div> <span class="blog-toc-item"><a href="/2014/09/16/iphoto_and_files_permission..html">iPhoto and files permission</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2014/01/31/vytoky_ukrayinskoyi_wikipediyi.html">Витоки української Вікіпедії</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/12/20/is_macosx_10.9_macos_9.x..html">Is MacOSX 10.9 == MacOS 9.x?</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/12/04/running_chef_roles_from_capistrano.html">Running Chef roles from Capistrano</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/11/01/chef_and_capistrano_integration.html">und Capiche</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/10/29/optimizing_jekyll.html">Speeding up Jekyll site</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/08/13/more_about_jekyll.html">More experience with Jekyll and setup changes</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/08/01/back_home.html">День останній: два роки після цунамі</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/31/ryusendo.html">Джерело Дракона, Рюсендо</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/31/hachimantai.html">День десятий: вулкани і болота Хачімантаю</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/30/tsuruno_onsen.html">Екстремальна екзотика в Цуруно онсен</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/29/day_8_tazawako.html">День восьмий: Найглибше озеро Японії</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/29/day_4_chusonji.html">День четвертий: багато буддистських святинь</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/25/day_5to7_tokoton_yama_IV.html">Токотон-яма (IV). Пекло.</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/25/day_5to7_tokoton_yama_III.html">Токотон-яма (III). Каньйон з гейзерами.</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/25/day_5to7_tokoton_yama_II.html">Автокемпінг Токотон-яма (II)</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/25/day_5to7_tokoton_yama_I.html">Три дні в Токотон-яма (I). Сукава онсен.</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/24/day_three_yamadera.html">День третій: Окама і Ямадера</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/23/druhyi_den.html">Другий день</a></span><span class="list_separatop">|</span> <span class="blog-toc-item"><a href="/2013/07/22/pershyi_den.html">День перший: Фукушіма, рухаємося на північ.</a></span><span class="list_separatop">|</span></div></table><div id="tiki-bot"><table style="border-:0;border-top:10px solid #000;margin:0;padding:0" cellspacing="0" cellpadding="0" width="100%" columns="2"><tbody><tr style="padding:0;margin:0"><td style="width:80%;background-color:#052D6C;color:#8b0b04;font-style:italic;font-wight:bold;text-align:right;border:0"> <br clear="all"><br clear="all"><br clear="all"><br clear="all"></td><td style="border:0;border-left:10px solid #000;width:120px;padding:5px"> <a class="address" href="mailto:dmytro.kovalov@gmail.com">дмитро ковальов</a></br> <a class="address" href="https://dmytro.github.com/">dmytro @ github </a><br> <a class="address" href="http://dmytro.sytes.net">dmytro.sytes.net</a><br></td></tr></tbody></table></div> <script>$("#content table tr:even").attr("class","even")</script></body></html>